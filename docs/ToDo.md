# План рефакторинга: Система контекста и аутентификации

## Этап 1: Базовая инфраструктура

### RequestContext ✅
- [x] Создать класс `RequestContext`
- [x] Добавить поля `user_id`, `metadata`, `timestamp`
- [x] Методы для сериализации/десериализации
- [x] Методы для работы с метаданными

### ContextMiddleware ✅
- [x] Создать класс `ContextMiddleware`
- [x] Проверка наличия контекста
- [x] Валидация контекста
- [x] Логирование ошибок

### AuthProvider ✅
- [x] Создать базовый класс `AuthProvider`
- [x] Методы для аутентификации
- [x] Создание контекста после аутентификации
- [x] Фабрика провайдеров

## Этап 2: Рефакторинг сервисов

### ToolCallManager ✅
- [x] Добавить поддержку контекста в tool_calls
- [x] Упростить API для работы с инструментами
- [x] Разделить ответственность с OpenAIService
- [x] Улучшить обработку ошибок

### OpenAIService ✅
- [x] Добавить поддержку контекста
- [x] Вынести создание чанков в отдельный метод
- [x] Упростить работу со стримами
- [x] Улучшить логирование

## Этап 3: Тестирование и отладка

### Тестирование базового функционала ✅
- [x] Проверить создание и валидацию контекста
- [x] Протестировать работу ContextMiddleware
- [x] Проверить аутентификацию через AuthProvider

### Тестирование инструментов ✅
- [x] Проверить передачу контекста в инструменты
- [x] Протестировать обработку ошибок
- [x] Проверить работу с дубликатами вызовов

### Тестирование стримов ✅
- [x] Проверить стриминг с контекстом
- [x] Протестировать tool calls в стриме
- [x] Проверить обработку ошибок в стриме

### Тестирование плагинов
- [x] Telegram Plugin
  - [x] Проверить создание контекста
  - [x] Протестировать обновление сообщений
  - [x] Проверить работу с историей
- [x] Console Plugin
  - [x] Проверить работу с дефолтным контекстом
  - [x] Протестировать стриминг
- [ ] REST API Plugin
  - [ ] Проверить аутентификацию
  - [ ] Протестировать изоляцию пользователей

## Этап 4: Документация

### Обновление документации
- [ ] Дополнить `@DESIGN.md` новыми диаграммами
- [ ] Обновить примеры в `@PLUGINS.md`
- [ ] Добавить секцию про контекст в `README.md`

### Создание руководств
- [ ] Руководство по работе с контекстом
- [ ] Руководство по созданию плагинов
- [ ] Примеры использования аутентификации

## Этап 5: Новые задачи

### Улучшение системы промптов
- [x] Исправить обработку system_prompt в BaseAgent
- [ ] Добавить поддержку шаблонов промптов
- [ ] Создать систему управления промптами
- [ ] Добавить версионирование промптов

### Улучшение планировщика задач
- [x] Добавить поддержку контекста в планировщик
- [ ] Улучшить обработку периодических задач
- [ ] Добавить поддержку часовых поясов
- [ ] Добавить систему уведомлений о задачах

### Оптимизация производительности
- [ ] Оптимизировать работу с БД в планировщике
- [ ] Улучшить кэширование контекста
- [ ] Оптимизировать обработку стримов
- [ ] Добавить метрики производительности

## Потенциальные проблемы
1. Возможные проблемы с передачей контекста в стримах ✅
2. Риск утечки контекста между пользователями ✅
3. Необходимость синхронизации истории сообщений с контекстом ✅
4. Возможные проблемы с производительностью при большом количестве пользователей
5. Необходимость оптимизации работы с БД в планировщике
6. Потенциальные проблемы с часовыми поясами в планировщике

## Следующие шаги
1. ✅ Начать с тестирования базового функционала
2. ✅ Особое внимание уделить стримам и tool calls
3. ✅ Проверить изоляцию пользователей
4. Завершить документацию и руководства
5. Реализовать систему управления промптами
6. Оптимизировать работу планировщика
7. Добавить метрики и мониторинг